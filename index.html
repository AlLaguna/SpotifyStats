<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
  <style>
    .loader {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 1000;
    }
    
    .spinner {
      width: 3rem;
      height: 3rem;
      border: 0.25em solid #f3f3f3;
      border-top: 0.25em solid #007bff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .card {
      border: none;
      box-shadow: 0 0.15rem 1rem rgba(0, 0, 0, 0.1);
      transition: transform 0.2s;
    }

    .card:hover {
      transform: translateY(-5px);
    }

    .card-header {
      background: #007bff;
      color: white;
      font-weight: 600;
    }
    .progress {
      height: 4px;
      background-color: #e9ecef;
      border-radius: 0;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1001;
    }
     .cover-image {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    .cover-container {
        position: relative;
        aspect-ratio: 1/1; /* Square ratio */
        overflow: hidden;
    }
    .index-badge {
        position: absolute;
        top: 10px;
        left: 10px;
        background: rgba(255, 255, 255, 0.9);
        color: #007bff;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 14px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .track-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 100%;
    }

    .play-count {
        background: #f8f9fa;
        padding: 5px 12px;
        border-radius: 20px;
        font-weight: 500;
        color: #007bff;
        border: 1px solid #dee2e6;
    }

    .progress-bar {
      transition: width 0.3s ease;
    }
  </style>
</head>
<body class="bg-light">
  <div class="progress">
    <div id="loadingProgress" class="progress-bar bg-primary" role="progressbar" style="width: 0%"></div>
  </div>

  <div class="loader">
    <div class="spinner"></div>
  </div>

  <div class="container mt-4" style="size: auto;margin: 1%; max-width:98%">
    <h1 class="text-primary mb-4">ðŸŽµ My Spotify Stats</h1>
    
    <!-- Main Tabs -->
    <ul class="nav nav-tabs main-tabs" id="mainTabs">
      <li class="nav-item">
        <a class="nav-link active" data-bs-toggle="tab" href="#weekly">
          <i class="bi bi-calendar-week me-2"></i>Weekly
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link" data-bs-toggle="tab" href="#monthly">
          <i class="bi bi-calendar-month me-2"></i>Monthly
        </a>
      </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content">
      <!-- Weekly Content -->
      <div class="tab-pane active" id="weekly">
        <!-- Sub Tabs -->
        <ul class="nav nav-tabs sub-tabs mt-3">
          <li class="nav-item">
            <a class="nav-link active" data-bs-toggle="tab" href="#weekly-songs">Top Songs</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" data-bs-toggle="tab" href="#weekly-artists">Top Artists</a>
          </li>
        </ul>
        
        <!-- Sub Content -->
        <div class="tab-content">
          <div class="tab-pane active" id="weekly-songs"></div>
          <div class="tab-pane" id="weekly-artists"></div>
        </div>
      </div>

      <!-- Monthly Content -->
      <div class="tab-pane" id="monthly">
        <!-- Sub Tabs -->
        <ul class="nav nav-tabs sub-tabs mt-3">
          <li class="nav-item">
            <a class="nav-link active" data-bs-toggle="tab" href="#monthly-songs">Top Songs</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" data-bs-toggle="tab" href="#monthly-artists">Top Artists</a>
          </li>
        </ul>
        
        <!-- Sub Content -->
        <div class="tab-content">
          <div class="tab-pane active" id="monthly-songs"></div>
          <div class="tab-pane" id="monthly-artists"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const cachedData = {
      weekly: { songs: null, artists: null },
      monthly: { songs: null, artists: null }
    };

    const loader = document.querySelector('.loader');

    window.onload = async () => {
      try {
        loader.style.display = 'block';
        updateProgress(0);
        setupTabHandlers();
        //weekly songs first
        cachedData.weekly.songs = await promisifiedServerCall('getWeeklySongs');
        populateSection('weekly-songs', cachedData.weekly.songs, 'songs');
        updateProgress(25);
        loader.style.display = 'none';
        //weekly artists
        cachedData.weekly.artists = await promisifiedServerCall('getWeeklyArtists');
        populateSection('weekly-artists', cachedData.weekly.artists, 'artists');
        updateProgress(50);
        loader.style.display = 'none';
        //monthly songs
        cachedData.monthly.songs = await promisifiedServerCall('getMonthlySongs');
        populateSection('monthly-songs', cachedData.monthly.songs, 'songs');
        updateProgress(75);
        loader.style.display = 'none';  
        //monthly artists
        cachedData.monthly.artists = await promisifiedServerCall('getMonthlyArtists');
        populateSection('monthly-artists', cachedData.monthly.artists, 'artists');
        updateProgress(100);
        loader.style.display = 'none';
        //setupTabHandlers();
      } catch (error) {
        showError(error);
      } finally {
        loader.style.display = 'none';
      }
    };

    function promisifiedServerCall(fnName) {
      return new Promise((resolve, reject) => {
        google.script.run
          .withSuccessHandler(resolve)
          .withFailureHandler(reject)
          [fnName]();
      });
    }

    function populateSection(sectionId, data, type) {
      const container = document.getElementById(sectionId);
      if (!data) return;
      var total = '';
      if(type === 'songs'){
        const total = '<div class="mt-3 text-muted small"> Total:' + data.total + 'songs </div>';
      }

      container.innerHTML = `
        <div class="card shadow">
          <div class="card-body">
            ${type === 'songs' ? `
              <div class="row row-cols-md-5 row-cols-sm-3 row-cols-xs-2">
                ${createSongsGrid(data.items)}
              </div>
            ` : `
              <div class="row row-cols-md-5 row-cols-sm-3 row-cols-xs-2">
                ${createArtistsList(data.items)}
              </div>
            `}
            ${total}
          </div>
        </div>
      `;
    }

    function createSongsGrid(tracks) {
      return tracks.map((track, index) => `
        <div class="col mb-2">
          <div class="card h-110 shadow-sm">
            <div class="cover-container">
              <div class="index-badge">${index + 1}</div>
              <img src="${track.coverUrl}" class="cover-image" alt="${track.name} cover">
            </div>
            <div class="card-body" style="padding:0.6rem 0.55rem;">
              <div class="track-info justify-content-center">
                <div>
                  <h5 class="card-title mb-1 text-center">${track.name}</h5>
                  <p class="card-text text-muted small mb-0 text-center">${track.artist}</p>
                </div>
                
              </div>

              <div class="track-info justify-content-center mt-2"><div class="play-count d-flex align-self-center">${track.count} escuchas</div></div>
            </div>
          </div>
        </div>
      `).join('');
    }

    function createArtistsList(artists) {
      return artists.map((artist, index) => `
        <div class="col mb-2">
          <div class="card h-80 shadow-sm">
            <div class="cover-container">
              <div class="index-badge">${index + 1}</div>
              <img src="${artist.coverUrl}" class="cover-image" alt="${artist.name} cover">
            </div>
            <div class="card-body" style="0.6rem 0.55rem;">
              <div class="track-info justify-content-center">
                <div>
                  <h5 class="card-title mb-1 text-center">${artist.name}</h5>
                </div>
                
              </div>
              <div class="track-info justify-content-center mt-2"><div class="play-count d-flex  align-self-center">${artist.count} escuchas</div></div>
            </div>
          </div>
        </div>
      `).join('');
    }

    function showSpinner(timeRange) {
      loader.style.display = 'flex';
    }

    function hideSpinner(timeRange) {
      loader.style.display = 'none';
    }

    function setupTabHandlers() {
      document.querySelectorAll('#mainTabs .nav-link').forEach(tab => {
        tab.addEventListener('shown.bs.tab', () => {
          
          const target = tab.getAttribute('href');
          document.querySelector(`${target} .nav-link:first-child`).click();


        });
      });

      document.querySelectorAll('#weekly .nav-link').forEach(tab => {
        tab.addEventListener('shown.bs.tab', () => {
          
          const target = tab.getAttribute('href');
          console.log(target);
          if(target == "#weekly-songs"){
            if(cachedData.weekly.songs == null){
              showSpinner();
              console.log("show");
            }
            else{
              hideSpinner();
              console.log("NOshow");
            }
          }
          else{
            if(cachedData.weekly.artists == null){
              showSpinner();
              console.log("show");
            }
            else{
              hideSpinner();
              console.log("NOshow");
            }
          }
          
        });
      });
      document.querySelectorAll('#monthly .nav-link').forEach(tab => {
        tab.addEventListener('shown.bs.tab', () => {
          
          const target = tab.getAttribute('href');
          console.log(target);
          if(target == "#monthly-songs"){
            if(cachedData.monthly.songs == null){
              showSpinner();
              console.log("show");
            }
            else{
              hideSpinner();
              console.log("NOshow");
            }
          }
          else{
            if(cachedData.monthly.artists == null){
              showSpinner();
              console.log("show");
            }
            else{
              hideSpinner();
              console.log("NOshow");
            }
          }
          
        });
      });
    }
    function updateProgress(percentage) {
      document.getElementById('loadingProgress').style.width = `${percentage}%`;
    }
    function showError(error) {
      loader.style.display = 'none';
      alert('Error: ' + error.message);
      console.error(error);
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
